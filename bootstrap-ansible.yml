---
# tasks file for bootstrap_ansible
- name: Set up ssh on vultr server
  hosts: "vultr"
  gather_facts: true
  become: true
  remote_user: root
  vars:
    inventory_group_name: ""

  pre_tasks:
    - name: Print out whoami
      ansible.builtin.command:
        cmd: whoami
      register: result
      changed_when: false

    - name: Display result
      ansible.builtin.debug:
        msg: "{{ result.stdout }}"

    - name: Debug ansible_default_ipv4
      ansible.builtin.debug:
        var: ansible_default_ipv4

  tasks:
    - name: Add ansible user
      ansible.builtin.user:
        name: ansible
        password: "*"
        groups: wheel

    - name: Create regular user with wheel privileges.
      ansible.builtin.user:
        name: admin
        password: "{{ admin_passwd | password_hash('sha512') }}"
        groups: wheel
        append: true
        shell: /bin/csh

    - name: Generate ssh key locally if doesn't exist
      community.crypto.openssh_keypair:
        path: ~/.ssh/ansible_id_ed25519
        type: ed25519
      delegate_to: localhost

    - name: Add ansible ssh key
      ansible.posix.authorized_key:
        user: ansible
        state: present
        key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/ansible_id_ed25519.pub') }}"

    - name: Add host to additional group in ansible inventory file
      ansible.builtin.lineinfile:
        path: "{{ inventory_file }}"
        insertafter: "{{ inventory_group_name }}"
        firstmatch: true
        line: "{{ inventory_hostname }} ansible_host={{ ansible_default_ipv4.address | default('127.0.0.1') }}"
      delegate_to: localhost
      when:
        - inventory_group_name is defined
        - inventory_group_name | length > 0
        - inventory_hostname not in groups[inventory_group_name]

  roles:
    - sshd
